<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        margin: 0;
        box-sizing: border-box;
      }

      canvas,
      video {
        display: block;
        width: 100%;
        height: 100%;
      }

      section {
        margin-bottom: 15px;
      }

      .my-button {
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        transition-duration: 0.4s;
        cursor: pointer;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .my-button.fail {
        background-color: #b84747;
      }
      .my-button:disabled {
        background-color: #aaa;
      }

      .canvases > * {
        background-color: #eee;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <section id="display-status-section" style="display: none">
      <button onclick="init()">init()</button>
      <span id="display-status"></span>
    </section>

    <section id="success-message-section">
      <div
        style="
          height: 100vh;
          display: flex;
          text-align: center;
          justify-content: center;
          align-items: center;
        "
      >
        <span>
          <h1>Success</h1>
          <p>Your image is printing</p>
          <br />
          <button class="my-button" onclick="init()">Tap to continue</button>
        </span>
      </div>
    </section>
    <section id="error-message-section">
      <div
        style="
          height: 100vh;
          display: flex;
          text-align: center;
          justify-content: center;
          align-items: center;
        "
      >
        <span>
          <h1>Error</h1>
          <p>Something went wrong</p>
          <button class="my-button fail" onclick="init()">
            Tap to try again
          </button>
        </span>
      </div>
    </section>

    <section id="start-instructions-section">
      <div style="text-align: center">
        <span>
          <h1>
            Once you tap a countdown will start, then 4 photos will be taken
          </h1>
          <p>Tap anywhere to begin</p>
        </span>
      </div>
    </section>

    <section id="capturing-instructions-section">
      <div style="text-align: center">
        <span>
          <h1>Your countdown has begun</h1>
          <p>Strike a pose</p>
        </span>
      </div>
    </section>

    <section id="stream-section">
      <div style="display: flex; justify-content: center">
        <div
          class="stream-container"
          style="width: 88vw; max-width: 700px; background-color: gray"
        >
          <video
            id="show-livestream"
            style="transform: scaleX(-1); width: 100%; height: 100%"
            autoplay
          ></video>
        </div>
      </div>
    </section>

    <section id="image-selection-instructions-section">
      <div style="text-align: center">
        <span>
          <h1>Tap the picture you want to print</h1>
          <p>If you don't like any of them just tap start again</p>
        </span>
      </div>
    </section>

    <section id="image-selected-section">
      <div style="display: flex; justify-content: center; position: relative">
        <div
          class="selected-image-container"
          style="
            width: 88vw;
            max-width: 700px;
            background-color: gray;
            display: flex;
            justify-content: center;
            align-items: center;
          "
        >
          <div style="position: absolute; color: white">
            <h1>Select your favourite photo</h1>
          </div>
          <div style="z-index: 1">
            <canvas id="selected-image-canvas"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section id="confirm-image-section">
      <div style="text-align: center">
        <span>
          <button
            id="print-image-button"
            class="my-button"
            onclick="sendSelectedImage(event)"
            disabled
          >
            Print photo
          </button>
          <button class="my-button fail" onclick="reInit()">Start again</button>
        </span>
      </div>
    </section>

    <section id="captured-images-section">
      <div
        class="canvases"
        style="
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          grid-gap: 20px;
          max-width: 100vw;
          padding: 0 20px;
        "
      >
        <span>
          <canvas id="canvas-1"></canvas>
        </span>
        <span>
          <canvas id="canvas-2"></canvas>
        </span>
        <span>
          <canvas id="canvas-3"></canvas>
        </span>
        <span>
          <canvas id="canvas-4"></canvas>
        </span>
      </div>
    </section>

    <section id="qr-section">
      <div style="text-align: center">
        <h1>Or scan the qr code to print your own photo</h1>
        <br />
        <img src="./assets/qr-code.png" />
      </div>
    </section>

    <script>
      let status = "PENDING_INITIALIZATION";
      let isRapid = true;
      let streamDetails;

      const successMessageSection = document.getElementById(
        "success-message-section"
      );
      const errorMessageSection = document.getElementById(
        "error-message-section"
      );
      const startInstructionsSection = document.getElementById(
        "start-instructions-section"
      );
      const capturingInstructionsSection = document.getElementById(
        "capturing-instructions-section"
      );
      const streamSection = document.getElementById("stream-section");
      const imageSelectionInstructionsSection = document.getElementById(
        "image-selection-instructions-section"
      );
      const imageSelectedSection = document.getElementById(
        "image-selected-section"
      );
      const confirmImageSection = document.getElementById(
        "confirm-image-section"
      );
      const capturedImagesSection = document.getElementById(
        "captured-images-section"
      );
      const qrSection = document.getElementById("qr-section");
      const printImageButton = document.getElementById("print-image-button");

      const displayStatusElm = document.getElementById("display-status");
      const showLiveStreamElm = document.getElementById("show-livestream");
      const selectedImageCanvas = document.getElementById(
        "selected-image-canvas"
      );

      const captureCanvases = [
        document.getElementById("canvas-1"),
        document.getElementById("canvas-2"),
        document.getElementById("canvas-3"),
        document.getElementById("canvas-4"),
      ];
      const startWebcamElm = document.getElementById("startWebcam");
      const snapElm = document.getElementById("snap");

      const hide = (elm) => elm.classList.add("hidden");
      const show = (elm) => elm.classList.remove("hidden");

      const setStatus = (x) => {
        status = x;
        displayStatusElm.innerHTML = `Status: "${status}"`;
        if (status === "PENDING_INITIALIZATION") {
        }
        if (status === "INITIALIZING") {
          printImageButton.disabled = true;
          hide(successMessageSection);
          hide(errorMessageSection);
          show(startInstructionsSection);
          hide(capturingInstructionsSection);
          show(streamSection);
          hide(imageSelectionInstructionsSection);
          hide(imageSelectedSection);
          hide(confirmImageSection);
          hide(capturedImagesSection);
          show(qrSection);
        }
        if (status === "READY") {
          printImageButton.disabled = true;
          hide(successMessageSection);
          hide(errorMessageSection);
          show(startInstructionsSection);
          hide(capturingInstructionsSection);
          show(streamSection);
          hide(imageSelectionInstructionsSection);
          hide(imageSelectedSection);
          hide(confirmImageSection);
          hide(capturedImagesSection);
          show(qrSection);
        }
        if (status === "CAPTURING") {
          printImageButton.disabled = true;
          hide(successMessageSection);
          hide(errorMessageSection);
          hide(startInstructionsSection);
          show(capturingInstructionsSection);
          show(streamSection);
          hide(imageSelectionInstructionsSection);
          hide(imageSelectedSection);
          hide(confirmImageSection);
          show(capturedImagesSection);
          hide(qrSection);
        }
        if (status === "UNSELECTED") {
          printImageButton.disabled = true;
          hide(successMessageSection);
          hide(errorMessageSection);
          hide(startInstructionsSection);
          hide(capturingInstructionsSection);
          hide(streamSection);
          show(imageSelectionInstructionsSection);
          show(imageSelectedSection);
          show(confirmImageSection);
          show(capturedImagesSection);
          hide(qrSection);
        }
        if (status === "SELECTED") {
          printImageButton.disabled = false;
          hide(successMessageSection);
          hide(errorMessageSection);
          hide(startInstructionsSection);
          hide(capturingInstructionsSection);
          hide(streamSection);
          show(imageSelectionInstructionsSection);
          show(imageSelectedSection);
          show(confirmImageSection);
          show(capturedImagesSection);
          hide(qrSection);
        }
        if (status === "SUCCESS") {
          printImageButton.disabled = true;
          show(successMessageSection);
          hide(errorMessageSection);
          hide(startInstructionsSection);
          hide(capturingInstructionsSection);
          hide(streamSection);
          hide(imageSelectionInstructionsSection);
          hide(imageSelectedSection);
          hide(confirmImageSection);
          hide(capturedImagesSection);
          hide(qrSection);
        }
        if (status === "FAIL") {
          printImageButton.disabled = true;
          hide(successMessageSection);
          show(errorMessageSection);
          hide(startInstructionsSection);
          hide(capturingInstructionsSection);
          hide(streamSection);
          hide(imageSelectionInstructionsSection);
          hide(imageSelectedSection);
          hide(confirmImageSection);
          hide(capturedImagesSection);
          hide(qrSection);
        }
      };

      const delay = async (x) => {
        return new Promise((resolve) => {
          const t = isRapid ? 1 : x;
          setTimeout(() => resolve(true), t);
        });
      };

      const getStreamDetails = async () => {
        console.log(Math.random());
        let streamData;
        try {
          streamData = await navigator.mediaDevices.getUserMedia({
            audio: false,
            video: {
              width: { min: 1024, ideal: 1280, max: 1920 },
              height: { min: 576, ideal: 720, max: 1080 },
            },
          });
        } catch (e) {
          console.log(e);
          window.alert(`Can't connect to webcam right now...`);
        }

        const settings = streamData
          .getVideoTracks()
          .find((x) => !!x)
          .getSettings();

        return {
          data: streamData,
          width: settings.width,
          height: settings.height,
        };
      };

      const setupStream = () => {
        showLiveStreamElm.width = streamDetails.width;
        showLiveStreamElm.height = streamDetails.height;
        showLiveStreamElm.srcObject = streamDetails.data;
      };

      const setupCaptureCanvases = () => {
        for (canvas of captureCanvases) {
          const context = canvas.getContext("2d");
          const { width, height } = streamDetails;
          canvas.width = width;
          canvas.height = height;
        }
      };
      const setupSelectedImageCanvas = () => {
        const context = selectedImageCanvas.getContext("2d");
        const { width, height } = streamDetails;
        selectedImageCanvas.width = width;
        selectedImageCanvas.height = height;
      };

      const handleSelectImage = (newCanvas, oldCanvas) => {
        var newContext = newCanvas.getContext("2d");

        const { width: newWidth, height: newHeight } = newCanvas;
        newContext.drawImage(oldCanvas, 0, 0, newWidth, newHeight);
      };
      const addSelectImageEvents = (initOnSelectImage) => {
        const onSelectImage = initOnSelectImage ? initOnSelectImage : () => {};

        for (const captureCanvas of captureCanvases) {
          captureCanvas.addEventListener("click", () => {
            handleSelectImage(selectedImageCanvas, captureCanvas);
            printImageButton.disabled = false;
            onSelectImage();
          });
        }
      };

      const sendSelectedImage = async (e) => {
        e.preventDefault();
        try {
          const resp = await fetch("http://localhost:3000/print-image", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ image: selectedImageCanvas.toDataURL() }),
          });
          console.log(await resp.json());
          setStatus("SUCCESS");
        } catch (error) {
          console.log(error);
          setStatus("FAIL");
        }
      };

      const captureImages = async () => {
        for (const captureCanvas of captureCanvases) {
          await delay(1000);
          const canvasContext = captureCanvas.getContext("2d");
          const { width, height } = streamDetails;

          canvasContext.scale(-1, 1);
          canvasContext.drawImage(showLiveStreamElm, -width, 0, width, height);
          canvasContext.setTransform(1, 0, 0, 1, 0, 0);
        }
      };

      const reInit = () => {
        setupStream();
        setupCaptureCanvases();
        setupSelectedImageCanvas();

        console.log("about to be ready: " + status);
        setStatus("READY");
      };
      const init = async () => {
        setStatus("INITIALIZING");

        streamDetails = await getStreamDetails();

        window.addEventListener("click", async () => {
          if (status === "READY") {
            setStatus("CAPTURING");
            await captureImages();
            setStatus("UNSELECTED");
            addSelectImageEvents(() => setStatus("SELECTED"));
          }
        });
        reInit();
      };

      init();
    </script>
  </body>
</html>
